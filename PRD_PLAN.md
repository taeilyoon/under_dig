# Under Dig - 제품 요구 사항 문서 (Part 1: 계획)

## 1. 제품 개요
**앱 이름**: Under Dig  
**플랫폼**: Android / iOS (Flutter)  
**장르**: 수직 생존 퍼즐 / 로그라이트  
**핵심 컨셉**: "Dig or Die (파거나 죽거나)". 플레이어가 공간, 적, HP를 관리하며 끝없는 수직 갱도를 내려가는 긴장감 넘치는 턴제 생존 게임.

## 2. 타겟 오디언스
-   **주 타겟**: 퍼즐 전략 장르를 즐기는 모바일 게이머 (예: *Hoplite*, *Downwell*).
-   **보조 타겟**: 짧고 굵은 플레이 타임(3~5분)을 선호하는 로그라이크 팬.
-   **동기 부여**: 높은 난이도, 빠른 의사결정, 만족스러운 콤보 플레이.

## 3. 핵심 게임플레이 루프
1.  **하강 (Descend)**: 적의 무리나 압박해오는 천장(추가 예정)을 피해 8x10 그리드를 내려갑니다.
2.  **생존 (Survive)**: 전략적인 위치 선정을 통해 적을 막거나, 공격하거나, 콤보를 터뜨립니다.
3.  **파밍 (Loot)**: 상자를 열어 업그레이드(HP, 공격력, 스킬)를 획득합니다.
4.  **사망 및 반복 (Die & Repeat)**: 로그라이트 특성상 죽음은 빈번하지만, 메타 진행을 통해 보상을 얻습니다.

## 4. 기능 요구 사항

### 1단계: MVP (완료/진행 중)
-   [x] **그리드 시스템**: 반응형 8x10 그리드.
-   [x] **턴 시스템**: 하이브리드 방식 (플레이어 이동 또는 2초 타이머).
-   [x] **기본 전투**: 공격, 반격, 안전한 처치(Safe Kill).
-   [x] **적 AI**: 수직 이동(중력), 충돌 및 대기 로직.
-   [x] **체인 콤보**: 연결된 적 동시 처치.
-   [x] **오브젝트**: 상자(Chest), 파괴 가능한 블록.

### 2단계: 알파 (다음 단계)
-   [ ] **게임 오버 루프**: 플레이어 사망 -> 결과 화면 -> 재시작.
-   [ ] **점수 시스템**: 도달 깊이, 처치 수, 최대 콤보.
-   [ ] **레벨 진행**: 난이도 곡선 (깊이에 따른 스폰율 증가).
-   [ ] **아이템 시스템**: 상자에서 사용 가능한 아이템 드롭 (포션, 주문서).

### 3단계: 베타 (폴리싱 및 깊이 추가)
-   [ ] **신규 적**: 원거리(궁수), 고속(슬라임), 탱커(골렘).
-   [ ] **스킬/업그레이드**: 액션 카드 또는 상황별 스킬 (예: 밀치기, 기절).
-   [ ] **비주얼 폴리싱**: 이동, 공격, 사망, 체인 폭발 애니메이션.
-   [ ] **오디오**: 배경음악(BGM) 및 효과음(SFX).

## 5. 기술 스택
-   **엔진**: Flutter + Flame
-   **상태 관리**: Flame 컴포넌트 트리(Component Tree).
-   **데이터 저장**: `shared_preferences` (최고 점수), Hive/Isar (플레이 기록).

## 6. 성공 지표 (KPIs)
-   **플레이 타임**: 평균 5분 이상.
-   **리텐션 (잔존율)**: D1 > 35%.
-   **콤보 만족도**: 플레이어의 체인 메카닉 활용도 (분석 툴로 추적).

## 7. 로드맵 및 우선순위
| 우선순위 | 기능 | 설명 |
| :--- | :--- | :--- |
| **P0** | 게임 오버 | 게임 루프의 완성을 위해 필수. |
| **P0** | 아이템 시스템 | 상자 파밍에 의미 부여. |
| **P1** | 점수 | 재플레이 동기 부여. |
| **P1** | 신규 적 | 게임플레이 다양성 확보. |
| **P2** | 비주얼 효과 | 타격감 및 완성도 향상 (화면 흔들림, 파티클). |
- Game Over 화면 UI 레이아웃 정의
  - 제목: Game Over / Score Summary
  - Score 요약 영역: Depth, Score, Best Score, Max Combo
  - 재시작 버튼: Restart Game
  - 공유 버튼: Share to SNS/Clipboard
  - 추가: 간단한 애니메이션(점수 증가 애니, 콤보 하이라이트)
- 책임/협업 포인트
  - 디자인 가이드라인에 맞춘 레이아웃 시안
  - UI 요소의 접근성 고려(라벨링, 키가드 네비게이션)
- Acceptance Criteria
  - [ ] 정확한 점수 정보가 표시된다
  - [ ] 버튼 동작이 올바르게 작동한다
  - [ ] 화면 전환 애니메이션이 매끄럽다
## 2단계: 알파 2 - 사망 탐지 기능 구현 및 메인 게임 루프 분리

- 목표
  - 사망 이벤트 탐지 로직 구현 및 메인 게임 루프의 모듈화/분리
- 아키텍처 개요
  - DeathDetector 컴포넌트: HP 감소, 충돌 이벤트를 모니터링하고 Death 이벤트를 발송
  - GameLoop/StateMachine: Running, DeathDetected, GameOver 간의 상태 전이 관리
- 핵심 트리거
  - HP <= 0 상태 도달
  - 치명적 충돌/환경 요인
- 인터페이스 및 통합 포인트
  - DeathDetector -> StateMachine 이벤트 전달
  - DeathDetected 시 GameOver 화면 전이 준비
- 비계산/테스트 포인트
  - Death 이벤트의 재현성 테스트 케이스
  - 상태 전이 시나리오 확인(Running -> DeathDetected -> GameOver)
- 기대 결과
  - 죽음이 안정적으로 감지되고 게임 오버 루프로 원활히 전환됩니다
## 2단계: 알파 2 - Restart 흐름 구현

- 목표
  - Restart 버튼 또는 회전 시 레벨/깊이 초기화, 점수 리셋, 오브젝트 초기화
- 흐름 개요
  - Restart 트리거 시점: GameOver 화면에서 Restart 선택
  - 초기화 순서: Depth/Score 초기화 → 오브젝트 재생성 → 상태 Running 재진입
- 데이터 초기화 포인트
  - depth, score, combo, inventory 초기화
- 성공 기준
  - 플레이 반복 시 게임 상태의 재생성 일관성 확보
## 2단계: 알파 2 - 점수 시스템 설계

- 목표
  - 포인트 구성 요소 정의: 깊이점수, 처치점수, 콤보보너스 등
- 설계 원칙
  - 각 요소의 가중치 명시
  - 점수 누적의 일관성 확보
- 산출 예시
  - 예: 깊이 5에서 처치 2회, 콤보 3연속일 경우의 점수 합계 예시
## 2단계: 알파 2 - 점수 계산 로직 구현

- 목표
  - 이벤트별 점수 산출 규칙 구현
- 테스트 포인트
  - 단위 테스트 케이스 작성 및 커버리지 확보
- 산출 예시/수식
  - 기본 공격/방어/이동/콤보 이벤트의 점수 증분 규칙 정의
## 2단계: 스테이지 진행도(stageProgress)와 스폰 곡선 정의

- 목표
  - 스테이지 진행도 증가에 따른 적/아이템 스폰률 조정 함수 정의
- 설계 포인트
  - 스테이지 진행도(stageProgress) vs 스폰률 매핑 테이블 또는 수식
  - 보상 곡선과 위험도 조정의 균형
## 2단계: 하이스코어 저장/로딩 로직 구현

- 목표
  - 로컬에 점수 기록 저장 및 불러오기 구현
- 저장 방법
  - shared_preferences와 Hive 중 적절한 모델 선택
- 포맷
  - 최종 점수, 깊이, 날짜, 플레이타임 등 메타데이터 저장
## 2단계: 콤보 시스템 추적 로직 구현 및 UI 표시

- 목표
  - 콤보 카운트, 유지 시간, 타임리셋 UI 표시 구현
- 데이터 흐름
  - 콤보 증가/리셋 이벤트 핸들링
- UI/UX 가이드
  - 콤보 관련 애니메이션 및 시각적 피드백
## 2단계: 아이템 시스템 설계

- 목표
  - 아이템 종류, 효과, 사용 규칙 정의
- 구조
  - 아이템 클래스/데이터 모델 스펙
- 정책
  - 중복 아이템 처리, 한계, 지속 시간 관리
## 2단계: 아이템 드롭 로직 설계

- 목표
  - 상자에서 아이템 드롭 확률 및 풀 구성 정의
- 규칙
  - 드롭 확률 분포, 아이템 가중치, 드롭 제한 규칙
## 2단계: 포션/주문서 아이템 효과 구현

- 목표
  - 체력 회복, 공격/방어/일시적 효과 등 아이템 효과 구체화
- 지속期間
  - 지속 시간, 쿨다운 정책 정의
## 2단계: 아이템 사용 UI/UX

- 목표
  - 툴팁, 아이템 인벤토리 UI, 사용 시나리오
- 접근성 및 UX 가이드
  - 직관적인 아이템 사용 흐름, 시각적 피드백
## 2단계: 스테이지 진행도(stageProgress)와 연동

- 목표
  - 스테이지 진행도 증가에 따라 보상과 위험도 조정
- 연동 전략
  - 스폰/보상 루프와 스테이지 진행도 매핑
## 2단계: 오디오/비주얼 피드백 개선

- 목표
  - 점수/콤보 UI 애니메이션, Game Over 애니메이션
- 사운드/비주얼 톤
  - 몰입도 향상을 위한 사운드 가이드라인
## 2단계: 테스트 계획 수립

- 목표
  - 점수 로직 단위 테스트 및 게임오버 흐름 end-to-end 테스트
- 테스트 범위
  - 점수 계산, 상태 전이, UI 흐름 검증
## 2단계: 데이터 모델 정의

- 목표
  - Score, Item, Inventory의 데이터 구조 설계
- 관계
  - Score 1:N Items, Inventory와의 관계 정의
## 2단계: 문서화 및 QA 체크리스트 작성

- 목표
  - 변경 사항 문서화 및 품질 확보
- 산출물
  - QA 체크리스트, 변경 로그, API/데이터 모델 문서화
## 2단계: 스폰 로직 통합 (StageProgress 기반)

- 목표: StageProgress가 증가함에 따라 SpawnCurve를 갱신하고, 게임 루프의 매 틱에서 tickSpawn()으로 엔emy를 생성하는 흐름을 도입한다.
- 주요 내용:
  - SpawnCurve를 기반으로 StageProgress에 따른 엔히/아이템 드롭 비율을 샘플링한다.
  - SpawnController.tickSpawn()를 게임 루프와 연결하여 매 틱 엔emy 수를 예측한다.
- 기대 효과: 난이도 확장에 따라 생성 빈도와 위험도 조정의 일관성 확보.
